## 安装教程

### -1.看常见问题解答

!> 这里收录了所有报错信息和对应的解决方法，记得过来看看！

+ [客户端常见问题解答](faq-client.md)
+ [管理端常见问题解答](faq-manage.md)

### 0.准备工作

1. 在桌面新建一个目录叫`mp`，并打开这个目录
2. 把`McPatchManage.jar`和`MiniHttpServer.jar`复制进去
3. 新建`manage.bat`，粘贴`java -jar xxx.jar & pause`（xxx换成McPatchManage.jar实际文件名）
4. 新建`httpserver.bat`，粘贴`java -jar xxx.jar & pause`（xxx换成MiniHttpServer.jar实际文件名）
5. 新建一个目录`workspace`

### 1.创建第一个更新包

首先把要加入更新的文件复制到`workspace`里来，这是一些栗子

+ 要更新模组，复制`.minecraft/mods`目录到`mp/workspace/.minecraft/mods`
+ 要更新资源包，复制`.minecraft/resourcepacks`目录到`mp/workspace/.minecraft/resourcepacks`
+ 要更新.minecraft目录旁边的`新玩家进服教程.txt`，复制`新玩家进服教程.txt`文件到`mp/workspace/新玩家进服教程.txt`
+ 如果你开了版本隔离，就需要复制`.minecraft/versions/your-version/mods`目录到`mp/workspace/.minecraft/versions/your-version/mods`
+ 其它文件以此类推，照葫芦画瓢即可。只复制要更新的文件，不更新的文件暂时不用复制
+ 注意如果你打算配置一键启动，那么Minecraft核心文件和Minecraft资源文件不要加入更新，大概率更新时会出问题！不要一股脑把整个.minecraft文件丢进去，要把核心文件和资源文件排除更新

然后运行manage.bat，输入`1`来开始创建第一个更新包。第一个版本号通常输入1.0，当然你也可以输入其它内容，好了之后按Enter

>  注意：版本号只能包括大小写字母数字，以及`!@#$()_+-=;',.`切勿使用中文或者空格

然后程序会列出你对哪些文件做了更改。因为我们是第一次打更新包，文件数量可能较多，粗略看一下就好

如果你要对这个版本写更新记录的话，可以在此时打开`changelogs.txt`文件粘贴进去并保存

一切妥当之后，输入`y`开始打包。首次打包内容较大，可能会花费相当多的时间，请耐心等待

待到出现“创建版本完成”的字样后，就说明打包成功了（更新包文件会保存在public目录下）

!> 注意：已发布的版本切勿手动删除，会导致后续更新全部出错！如需撤回版本请阅读[版本发错了怎么办](#版本发错了怎么办)

### 2.开启自带的HttpServer

1. 双击运行httpserver.bat，启动成功后复制API地址，粘贴到浏览器打开，如果一切顺利浏览器会显`FORBIDDEN: Directory is unable to show`
2. 如果你需要从外网进行访问，把这个地址换成外网IP或者域名再访问一次，确保从外网访问没问题

### 3.安装客户端

1. 复制一份你的服务器客户端文件夹到桌面上，并打开这个目录
2. 把McPatchClient.jar复制到.minecraft目录的旁边
3. 用压缩软件打开McPatchClient.jar，把`config.yml`解压出来，并打开编辑
4. 将服务端的API地址粘贴到config.yml中的`server`选项后面，然后保存关闭
5. 双击运行McPatchClient.jar开始更新刚刚打包的第一个版本
6. 更新完成后检查一下`mc-patch-version.txt`这个文件的内容，确保是`1.0`或者你刚创建的版本号

> 移动McPatchClient.jar位置时，需要带着`mc-patch-version.txt`和`config.yml`一起移动

7. 到此客户端配置完毕，如果希望在游戏启动时自动弹出更新，而不是每次都手点，可以参考一键启动的页面
8. 目前一键启动仅支持：[Windows平台](javaagent-windows.md)和[Android平台](javaagent-android.md)。如果你安装了猫反作弊模组，请转而使用[模组形式一键启动](modclient-all-platform.md)（支持所有平台）
9. 如果你确定config.yml已经调试完成，可以把这个文件打包回McPatchClient.jar里，然后删除外部的config.yml，程序会自动读取Jar内部的配置文件，以保持目录整洁

> 因为有自动扫描功能的存在，McPatchClient.jar的位置并不会影响更新到哪个路径，所以McPatchClient.jar无论放在哪个子目录下面运行都不会影响更新结果

### 4.后续发布新版

1. 后续发布新版本很简单，只需要对workspace目录下的文件做修改（就像对本地文件一样修改就好），然后打出更新包，非常简单
2. 比如我想要删除客户端的一个模组a.jar再添加一个新的模组b.jar，那么只需要在workspace目录下删掉a.jar然后复制进去b.jar，接着打包新版本就好
3. 如果新旧文件同名，但文件内容被修改了也只一样的做法：直接覆盖旧文件就好，程序也能自动检测到
4. 对目录的新建和删除也是一样，该怎么新建怎么新建，该什么删除怎么删除，就就像对本地文件一样进行这些操作一样
5. 如果你在workspace目录改了一些文件，但又觉得不妥，想要丢弃这些修改，可以启动管理端，输入`4`来还原

## 一些使用小提示

### 某些情况下会导致个别文件更新失败

客户端的某个文件在更新之前，如果文件内容被人为修改过或者直接删除了，会导致客户端程序跳过对此文件的更新

这是文件更新机制所致的，服务端打包更新包时不会记录文件完整内容，而是根据旧文件内容+新文件内容进行对比，生成差异文件，或者说补丁文件。当更新包被下载到客户端后，需要原来的旧文件+补丁文件（差异文件）才能生成（更新成）新文件的，如果旧文件被修改或者删除，仍要强行进行文件更新会导致文件数据错乱，这种情况是无法进行任何更新的，所以程序在遇到这种情况时会跳过这些不能更新的文件，但其它文件正常更新不受影响

正因为有这个机制的存在，玩家自己添加删除修改的文件不会被更新系统覆盖，即使遇到更新也不会改动，可以保留玩家自己的个性化定制数据

这些不能更新的文件在所有的未来版本里都会跳过更新（因为文件没有受到更新，文件校验会一直对不上），直到服务端在某个未来版本里对此文件进行了删除操作才会打破这个循环，重新加入更新

### 目录用途说明

1. history目录：用来作为对比，以计算你对workspace目录做了哪些修改的目录
   1. 这个目录正常情况下和workspace目录里的文件一致，当你修改了workspace目录下的文件通过history目录进行对比就能算出你改了哪些文件目录
   2. history目录下的内容由程序自动维护，千万不要手动修改history目录下的文件，否则程序计算出来的二进制文件差异内容会出现差错，导致客户端无法更新到新版本
   3. 若不小心修改了history目录的文件，可以参考[这里](#不小心修改了history目录)来修复
2. public目录：用来存放打好的更新包，每个更新包有2个文件：二进制数据文件(.bin)和元数据文件(.json)，还有一个版本列表文件mc-patch-versions.txt
   1. 如果在一个版本中你仅做了删除文件，删除目录，新建目录的操作，同时又没有进行任何修改文件和新增文件的时候，最终打出来的更新包就只会包含一个json文件，而没有bin文件，这是正常现象
3. worksapce目录：用来日常维护客户端文件内容的目录，要对客户端做更新可以直接对整个文件做修改，然后打出更新包，客户端就会自动更新到新版本了

### 自由化部署

若你不想使用MiniHttpServer.jar，而是有更好的方式提供HTTP文件服务，比如Nginx，Apache，网站主机，对象存储等，那么只需要参考本章节就能轻松实现自由化部署，之后MiniHttpServer.jar就可以安全删除了

以对象存储为例，你每打一个新版本，比如10.0，就需要将public目录里面的这三个文件上传到对象存储上：

1. 二进制数据文件(.bin)：`10.0.mc-patch.json`（如果这个文件不存在就不用上传）
2. 元数据文件(.json)：`10.0.mc-patch.bin`
3. 版本列表文件(mc-patch-versions.txt)：此文件每次都需要上传

然后，客户端server选项要这样填写：

1. 首先拿到“版本列表文件(mc-patch-versions.txt)”的URL，比如`https://duixiangcunchu.com/some-folder/mc-patch-versions.txt`
2. 在浏览器打开这个URL，确认能顺利访问之后，删除URL末尾的`/mc-patch-versions.txt`部分，变成这样`https://duixiangcunchu.com/some-folder`
3. 然后粘贴进客户端配置文件的server选项后面

### 版本号并非判断新旧的依据

版本号并没有规定一定要往高走，也可以往低走。就是说你可以从1.5版本更新到1.4版本。这算更新而非回退

因为版本的前后关系并不是直接判断版本号文字计算出来的，而是按照你打每个版本的时间顺序，后打的版本总是比先打的版本要新。版本号只是个标签罢了，不作为任何判断版本前后的依据

至于哪个版本更新，哪个版本更旧？可以亲自打开“版本列表文件(mc-patch-versions.txt)”一看便知（注意只能看不能改）

### 版本发错了怎么办

版本号一旦发布就不能撤回，撤回可能会导致客户端某些文件更新永久更新失败，而且这种问题很难发现和调试。你应该额外再发布一个版本来替代撤回

如果你100%确定刚发布的错误版本没有任何人下载的话，可以使用以下方法来撤回：

1. 打开public/mc-patch-versions.txt文件，将错误版本那一行连带后面所有的行都删除掉（前面的千万别改动）
2. 比如123456这6个版本中，4出了问题，就要撤回456三个版本，就在`mc-patch-versions.txt`里删除456这三行，使3这一行成为文件末尾
3. 接着删除public目录下456这三个版本对应的json文件和bin文件
4. 最后运行管理端，在主菜单输入`bv`进入隐藏菜单，恢复workspace目录和history目录的内容。恢复所需的时间和已有版本的数量成正比，如果版本非常多，过程可能会非常慢
5. 这样就回退到了你发布错误版本号之前的状态了
6. 如果你不能100%保证没有任何人下载过这个错误的版本，就不要撤回版本，否则那个人会出现各种各样的奇奇怪怪的问题

### 不小心修改了history目录

如果你不小心修改了history目录下的内容，可以在主菜单输入`bv`进入隐藏菜单来同时还原workspace目录和history目录，注意使用此命令前请三思，如使用不当可能会误删重要文件

恢复所需的时间和已有版本的数量成正比，如果版本非常多，过程可能会非常慢

### “加密”配置文件和版本号文件

> 此特性仅McPatchClient 1.0.11或更高版本支持

这里的加密不是真的加密，只是将内容编码后以非明文保存而已，不能起到安全防护的作用

加密配置文件（config.yml）：将整个配置文件内容复制后使用Base64进行编码，然后删掉原有内容，将编码后的内容粘贴进去，然后在文件的开头添加一个英文冒号`:`用来告诉程序配置文件被“加密”了，使用之前要先“解密”

加密版本号文件（mc-patch-version.txt）：将整个版本号文件内容复制后使用Base64进行编码，然后删掉原有内容，将编码后的内容粘贴进去，然后在文件的开头添加一个英文冒号`:`用来告诉程序配置文件被“加密”了，使用之前要先“解密”

注意：配置文件和版本号文件“加密”后，不会影响日志文件里的账号密码信息的显示，如果在意，可以在配置文件里禁用日志文件生成
